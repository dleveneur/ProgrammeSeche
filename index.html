<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Programme Sèche 90 Jours</title>
    <!-- Chargement de Tailwind CSS pour le style -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a; /* Slate 900 */
            color: #e2e8f0; /* Light text for dark background */
        }
        .container-app {
            max-width: 1024px;
            margin: auto;
            min-height: 100vh;
            padding-bottom: 40px;
        }
        .scroll-container {
            max-height: 70vh;
            overflow-y: auto;
            /* Scrollbar style for dark mode */
            scrollbar-color: #0d9488 #1e293b;
            scrollbar-width: thin;
        }
        /* Style pour les boutons de tab */
        .tab-button {
            transition: all 0.3s ease;
            cursor: pointer;
            border-bottom: 3px solid transparent;
        }
        .tab-button.active {
            border-color: #22d3ee; /* Cyan 400 */
            color: #22d3ee;
            font-weight: 600;
        }
        .loading-ring {
            display: inline-block;
            width: 24px;
            height: 24px;
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            border-top-color: #22d3ee; /* Cyan */
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        /* Style pour la checkbox de validation */
        input[type="checkbox"] {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            height: 20px;
            width: 20px;
            border: 2px solid #475569; /* slate-600 */
            border-radius: 4px;
            cursor: pointer;
            outline: none;
            transition: all 0.2s ease;
            position: relative;
        }

        input[type="checkbox"]:checked {
            background-color: #10b981; /* emerald-500 */
            border-color: #10b981;
        }

        input[type="checkbox"]:checked::after {
            content: '✓';
            color: white;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 14px;
            font-weight: bold;
        }
    </style>
    <!-- Logique JavaScript principale -->
    <script>

        // Définition des variables globales
        const userId = 'local-user'; 

        window.appData = {
            userId: userId,
            isAuthReady: false,
            // Indique que la sauvegarde est locale dans le navigateur
            isDataSavingEnabled: true, 
            storageType: 'localStorage'
        };

        // Programme et logiques
        // Chaque séance contient des "blocks" (super-sets ou circuits)
        // Chaque block a ses sets et son temps de repos après le block.
        // Les exercices individuels sont des "subExercises" dans le block.
        window.program = {
            weeklySchedule: {
                0: 'Repos', // Dimanche
                1: 'Séance 1', // Lundi
                2: 'Séance 2', // Mardi
                3: 'Repos', // Mercredi
                4: 'Séance 3', // Jeudi
                5: 'Séance 4', // Vendredi
                6: 'Séance 5', // Samedi
            },
            sessions: {
                'Séance 1': { 
                    name: 'Force/Triceps/Abdominaux', 
                    blocks: [
                        { // BLOCK 1: Force/Push Super-set
                            sets: '3-4', 
                            rest: '1\'', 
                            subExercises: [
                                { name: 'Pompes diamant', reps: 'Max', prompt: 'Démonstration de Pompes Diamant, gros plan, homme en action', imgUrl: '' },
                                { name: 'Pompes serrées pieds surélevés', reps: '15', prompt: 'Démonstration de Pompes serrées avec pieds surélevés sur un banc', imgUrl: '' },
                            ]
                        },
                        { // BLOCK 2: Triceps/Dips Super-set
                            sets: '3', 
                            rest: '1\'30', 
                            subExercises: [
                                { name: 'Tirages élastiques triceps', reps: 'Échec', prompt: 'Démonstration de Tirage élastique pour les triceps, vue de profil', imgUrl: '' },
                                { name: 'Dips sur barre', reps: 'Max', prompt: 'Démonstration de Dips sur barres parallèles', imgUrl: '' },
                            ]
                        },
                        { // BLOCK 3: Core Circuit
                            sets: '3', 
                            rest: '1\'30', 
                            subExercises: [
                                { name: 'Gainage commando', reps: '15-15', prompt: 'Démonstration de Gainage Commando (passage de coudes à mains) en position stable', imgUrl: '' },
                                { name: 'Aller-retours avec la roue', reps: '20', prompt: 'Démonstration d\'Aller-retour avec la roue abdominale à genoux', imgUrl: '' },
                                { name: 'Relevés de jambes sur le banc', reps: '50', prompt: 'Démonstration de Relevés de jambes tendues sur le banc pour abdominaux', imgUrl: '' },
                            ]
                        },
                    ]
                },
                'Séance 2': { 
                    name: 'Cardio/Full Body Dynamique', 
                    blocks: [
                        { // BLOCK 1: Cardio Power Super-set
                            sets: '3-4', 
                            rest: '1\'30', 
                            subExercises: [
                                { name: 'Tractions dynamiques sans élastiques', reps: '15', prompt: 'Démonstration de Tractions dynamiques sur barre, corps entier', imgUrl: '' },
                                { name: 'Burpees DB', reps: '20', prompt: 'Démonstration d\'un Burpee avec haltères (Burpees DB), développement au-dessus de la tête', imgUrl: '' },
                            ]
                        },
                        { // BLOCK 2: Cardio Endurance Super-set
                            sets: '3-4', 
                            rest: '1\'30', 
                            subExercises: [
                                { name: 'Montées de genoux', reps: '30\'\'', prompt: 'Démonstration de Montées de genoux rapides (High Knees) en pleine course', imgUrl: '' },
                                { name: 'Fentes sautées dynamiques', reps: '1\'', prompt: 'Démonstration de Fentes sautées dynamiques (Jumping Lunges)', imgUrl: '' },
                            ]
                        },
                        { // BLOCK 3: Push/Core Circuit
                            sets: '3', 
                            rest: '1\'30', 
                            subExercises: [
                                { name: 'Pompes avec montées de genoux alternées', reps: '45\'\'', prompt: 'Démonstration de Pompes suivies d\'une Montée de genou alternée', imgUrl: '' },
                                { name: 'Pompes archers', reps: '20', prompt: 'Démonstration de Pompes Archers, fléchissement unilatéral', imgUrl: '' },
                                { name: 'Battements de jambes tendues', reps: '45\'\'', prompt: 'Démonstration de Battements de jambes tendues au sol pour abdominaux', imgUrl: '' },
                            ]
                        },
                    ]
                },
                'Séance 3': { 
                    name: 'Dos/Gainage/Abdominaux', 
                    blocks: [
                        { // BLOCK 1: Back Super-set
                            sets: '4', 
                            rest: '2\'', 
                            subExercises: [
                                { name: 'Tirages 1 bras sur le TRX', reps: '15-15', prompt: 'Démonstration de Tirage à un bras sur TRX, dos bien droit', imgUrl: '' },
                                { name: 'Pompes + tirage unilatéral haltères', reps: '30 (15-15)', prompt: 'Démonstration de Renegade Row (Pompe + Tirage unilatéral avec Haltères)', imgUrl: '' },
                            ]
                        },
                        { // BLOCK 2: Dynamic Core Super-set
                            sets: '4', 
                            rest: '2\'', 
                            subExercises: [
                                { name: 'Gainage TRX (Avancés de bras)', reps: '45\'\'', prompt: 'Démonstration de Gainage TRX dynamique avec avancée des bras', imgUrl: '' },
                                { name: 'Superman avec mouvement alterné', reps: '45\'\'', prompt: 'Démonstration de Superman (lever bras et jambe opposés)', imgUrl: '' },
                            ]
                        },
                        { // BLOCK 3: Rotation/Endurance Core Circuit
                            sets: '4', 
                            rest: '2\'', 
                            subExercises: [
                                { name: 'Micro va et vient avec la roue', reps: '45\'\'', prompt: 'Démonstration de Micro va-et-vient avec la roue abdominale en position de pompe', imgUrl: '' },
                                { name: 'Reverse planks rotation', reps: '20-20', prompt: 'Démonstration de Reverse Plank avec rotation du bassin', imgUrl: '' },
                                { name: 'Sprawls dynamiques', reps: '45\'\'', prompt: 'Démonstration de Sprawls dynamiques (Ramener les jambes rapidement après la planche, sans sauter)', imgUrl: '' },
                            ]
                        },
                    ]
                },
                'Séance 4': { 
                    name: 'Jambes/Full Body Puissance', 
                    blocks: [
                        { // BLOCK 1: Leg Power Super-set
                            sets: '4', 
                            rest: '1\'30', 
                            subExercises: [
                                { name: 'Splits lunges avec développé barre au-dessus de la tête', reps: '20', prompt: 'Démonstration de Fentes (Split Lunges) avec Développé Militaire au-dessus de la tête, barre tenue', imgUrl: '' },
                                { name: 'Thrusters (Squat + développé militaire)', reps: '45\'\'', prompt: 'Démonstration de Thrusters (Squat + Développé Militaire) avec une barre', imgUrl: '' },
                            ]
                        },
                        { // BLOCK 2: Explosive Legs
                            sets: '4', 
                            rest: '1\'30', 
                            subExercises: [
                                { name: 'Knee tuck jumps dynamiques', reps: '30\'\'', prompt: 'Démonstration de Knee Tuck Jumps (sauts avec genoux à la poitrine) dynamiques', imgUrl: '' },
                                { name: 'Burpees enchaînés (avec pompes)', reps: '1\'', prompt: 'Démonstration de Burpees complets enchaînés avec pompe', imgUrl: '' },
                            ]
                        },
                        { // BLOCK 3: Unilateral/Core Circuit
                            sets: '4', 
                            rest: '1\'30', 
                            subExercises: [
                                { name: 'Rotations avec sci model moyen (Orange)', reps: '30-30', prompt: 'Démonstration de Rotations du buste avec résistance (câble ou élastique) pour les obliques, mouvement lent', imgUrl: '' },
                                { name: 'Squats 1 jambe (Pistol ou grande amplitude)', reps: '15-15', prompt: 'Démonstration de Pistol Squat assisté (Squat sur une jambe)', imgUrl: '' },
                                { name: 'Chandelles', reps: '30', prompt: 'Démonstration de Chandelles (relevé de bassin vers le haut) pour abdominaux', imgUrl: '' },
                            ]
                        },
                    ]
                },
                'Séance 5': { 
                    name: 'Endurance/Full Body Technique', 
                    blocks: [
                        { // BLOCK 1: Back/Hold Super-set
                            sets: '2-3', 
                            rest: '1\'30', 
                            subExercises: [
                                { name: 'Tractions avec les étriers', reps: 'Max', prompt: 'Démonstration de Tractions lentes sur anneaux ou étriers pour le dos', imgUrl: '' },
                                { name: 'L-sit sur étriers', reps: '1\'', prompt: 'Démonstration de Maintien L-Sit sur barres parallèles ou étriers', imgUrl: '' },
                            ]
                        },
                        { // BLOCK 2: Cardio/Biceps Super-set
                            sets: '2-3', 
                            rest: '1\'30', 
                            subExercises: [
                                { name: 'Squats sautés', reps: '45\'\'', prompt: 'Démonstration de Squats Sautés (Jump Squat) rapides', imgUrl: '' },
                                { name: 'Curls biceps au TRX', reps: '20', prompt: 'Démonstration de Curls Biceps avec le TRX', imgUrl: '' },
                            ]
                        },
                        { // BLOCK 3: Core Endurance Circuit
                            sets: '2-3', 
                            rest: '1\'30', 
                            subExercises: [
                                { name: 'Mountain climbers dynamiques', reps: '45\'\'', prompt: 'Démonstration de Mountain Climbers dynamiques avec glides sous les pieds', imgUrl: '' },
                                { name: 'Rotations au KB ou haltère (Anti-rotations)', reps: '45\'\'', prompt: 'Démonstration de Presse Pallof (Anti-Rotation) avec kettlebell ou haltère tenu', imgUrl: '' },
                                { name: 'Gainage de face et sur côté (Alterné)', reps: '1\'30', prompt: 'Démonstration de Gainage Alterné (Face et Côté) en transition', imgUrl: '' },
                            ]
                        },
                    ]
                }
            }
        };

        // --- Fonctions d'aide (Date et Programme) ---
        function getProgramDay(date) {
            // Le programme est sur 7 jours. 
            const dayOfWeek = date.getDay(); // 0 (Dim) - 6 (Sam)
            return window.program.weeklySchedule[dayOfWeek];
        }

        function formatDate(date) {
            return date.toLocaleDateString('fr-FR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        }
        
        // Fonction utilitaire pour le Debounce
        function debounce(func, timeout = 300) {
            let timer;
            return (...args) => {
                clearTimeout(timer);
                timer = setTimeout(() => {
                    func.apply(this, args);
                }, timeout);
            };
        }


        // --- Logique de Stockage Local Simplifiée (Fait/Pas Fait) ---

        function initializeApp() {
            window.appData.isAuthReady = true;
            console.log("Application initialisée. Sauvegarde locale activée.");
            renderApp();
        }

        // Fonction de sauvegarde réelle (interne) pour le statut Fait/Pas Fait
        // Utilise le nom du sous-exercice comme clé, ce qui est unique au sein de la session
        window._toggleExerciseDone = function(sessionId, exerciseName, isDone) {
            const today = window.state.today;
            // IMPORTANT : Utiliser un clone pour ne pas altérer l'objet date dans l'état
            const dateForStorage = new Date(today); 
            dateForStorage.setHours(0, 0, 0, 0); 
            const dateKey = dateForStorage.toISOString().split('T')[0];
            const storageKey = `${userId}_${dateKey}`; // Clé unique par utilisateur/jour

            // 1. Charger les logs existants pour aujourd'hui
            let dailyLogs = JSON.parse(localStorage.getItem(storageKey) || '{}');

            // 2. Assurer la structure de la session
            if (!dailyLogs.sessions) dailyLogs.sessions = {};
            if (!dailyLogs.sessions[sessionId]) {
                dailyLogs.sessions[sessionId] = { 
                    sessionName: window.program.sessions[sessionId].name,
                    exercises: {} // Les logs utilisent le nom de l'exercice/sous-exercice comme clé
                };
            }

            // 3. Enregistrer le statut de l'exercice
            dailyLogs.sessions[sessionId].exercises[exerciseName] = {
                isDone: isDone,
                timestamp: Date.now() 
            };

            // 4. Sauvegarder l'objet mis à jour
            try {
                localStorage.setItem(storageKey, JSON.stringify(dailyLogs));
                console.log(`Exercise ${exerciseName} marked as done: ${isDone}.`);
            } catch (error) {
                console.error("Erreur lors de la sauvegarde dans localStorage:", error);
                displayMessage("Erreur de sauvegarde locale. Votre navigateur est peut-être en mode privé.", 'error');
            }
        }
        
        // Créer la fonction debounced (publique) pour la rendre fluide
        window.debouncedToggleDone = debounce(window._toggleExerciseDone, 300);
        
        function displayMessage(message, type = 'info') {
            const container = document.getElementById('app-message-container');
            if (!container) return;

            const baseClasses = "p-3 rounded-lg mb-4 text-center text-sm font-medium transition-opacity duration-300";
            let colorClasses = '';

            switch (type) {
                case 'success':
                    colorClasses = "bg-green-900 border border-green-700 text-green-300";
                    break;
                case 'error':
                    colorClasses = "bg-red-900 border border-red-700 text-red-300";
                    break;
                case 'warning':
                default:
                    colorClasses = "bg-yellow-900 border border-yellow-700 text-yellow-300";
                    break;
            }

            container.innerHTML = `<div class="${baseClasses} ${colorClasses}">${message}</div>`;
            setTimeout(() => {
                // Effacer le message après 5 secondes
                container.innerHTML = '';
            }, 5000);
        }
        
        // Fonction pour récupérer les logs (pour l'affichage quotidien) - MAINTENANT SYNCHRONE
        window.getDailyLogs = function(dateKey) {
            const storageKey = `${userId}_${dateKey}`;
            const rawData = localStorage.getItem(storageKey);
            let logs = {};

            if (rawData) {
                try {
                    const parsedData = JSON.parse(rawData);
                    logs = parsedData.sessions || {};
                } catch (e) {
                    console.error("Erreur de parsing des logs locaux:", e);
                }
            }
            return logs; // Retourne les logs directement
        }
        
        // Gère la récupération initiale des logs et le rendu du tracker
        window.attachLocalListener = function(dateKey) {
             // 1. Récupérer les logs de manière synchrone
             const logs = window.getDailyLogs(dateKey);
             window.currentLogs = logs;
             
             // 2. Forcer le re-rendu du tracker avec les logs mis à jour
             const sessionName = getProgramDay(window.state.today);
             const session = window.program.sessions[sessionName];
             if (sessionName !== 'Repos' && document.getElementById('session-tracker')) {
                document.getElementById('session-tracker').innerHTML = renderSessionTracker(sessionName, session);
             }
        }

        // --- Logique de rendu ---
        window.renderApp = function() {
            // Initialisation de l'état de l'application
            window.state = {
                activeTab: 'today', // 'today' ou 'calendar'
                // Créer une nouvelle instance de Date() pour l'état initial
                today: new Date(), 
                todayDateKey: new Date().toISOString().split('T')[0]
            };
            
            // Rendre le composant principal
            document.getElementById('app').innerHTML = `
                <div class="container-app p-4">
                    <h1 class="text-4xl font-extrabold text-center text-cyan-400 my-6 tracking-wide">FITNESS 90 Jours</h1>
                    
                    <div id="app-message-container">
                        <div class="p-3 bg-green-900 border border-green-700 text-green-300 rounded-lg mb-4 text-center text-sm font-medium">
                            ✅ Sauvegarde **locale** activée (dans votre navigateur). Statut de l'exercice optimisé.
                        </div>
                    </div>

                    <!-- Navigation par Onglets -->
                    <div class="flex justify-center border-b border-slate-700 mb-6">
                        <div id="tab-today-button" class="tab-button p-4 text-slate-400 active" onclick="switchTab('today')">
                            SÉANCE DU JOUR
                        </div>
                        <div id="tab-calendar-button" class="tab-button p-4 text-slate-400" onclick="switchTab('calendar')">
                            CALENDRIER COMPLET
                        </div>
                    </div>

                    <!-- Contenu des Onglets -->
                    <div id="content-today"></div>
                    <div id="content-calendar" class="hidden"></div>
                </div>
            `;
            
            window.switchTab = function(tab) {
                window.state.activeTab = tab;
                document.getElementById('content-today').classList.toggle('hidden', tab !== 'today');
                document.getElementById('content-calendar').classList.toggle('hidden', tab !== 'calendar');
                
                document.getElementById('tab-today-button').classList.toggle('active', tab === 'today');
                document.getElementById('tab-calendar-button').classList.toggle('active', tab === 'calendar');
                
                if (tab === 'today') {
                    renderTodayView();
                } else {
                    renderCalendarView();
                }
            }
            
            renderTodayView(); // Rendre l'onglet par défaut
        }

        // --- Vues Spécifiques ---

        function renderTodayView() {
            const today = window.state.today;
            const sessionName = getProgramDay(today);
            const session = window.program.sessions[sessionName];

            let htmlContent = `
                <div class="bg-slate-800 p-6 rounded-2xl shadow-2xl border border-slate-700">
                    <h2 class="text-xl font-light text-slate-400">${formatDate(today)}</h2>
                    <p class="text-3xl font-bold mt-2 mb-4">
                        ${sessionName === 'Repos' ? 'Jour de Repos Actif' : 'Séance à réaliser :'} 
                        <span class="${sessionName === 'Repos' ? 'text-red-400' : 'text-cyan-400'} block text-2xl font-extrabold mt-1">
                            ${sessionName} (${session ? session.name : 'RÉCUPÉRATION'})
                        </span>
                    </p>
                    ${sessionName === 'Repos' ? `
                        <div class="p-4 bg-slate-700 text-gray-300 rounded-xl mt-4 border border-slate-600">
                            Prenez le temps de récupérer, la progression continue même au repos !
                        </div>
                    ` : `
                        <p class="text-slate-400 mb-6 mt-4">Cochez les sous-exercices complétés. Chaque bloc représente un super-set/circuit.</p>
                        <div id="session-tracker" class="scroll-container space-y-6">
                            <!-- Sera rempli par renderSessionTracker après la récupération des logs -->
                            <div class="flex justify-center items-center h-24">
                                <span class="loading-ring"></span>
                            </div>
                        </div>
                    `}
                </div>
            `;
            document.getElementById('content-today').innerHTML = htmlContent;
            
            // Récupérer les logs et attacher l'écouteur local (déclenche le rendu du tracker)
            if (sessionName !== 'Repos') {
                 window.attachLocalListener(window.state.todayDateKey);
            }
        }

        function renderSessionTracker(sessionId, session) {
            // Utilise la nouvelle structure: session.blocks
            if (!session || !session.blocks) return '';
            
            let html = '';
            // Utilise window.currentLogs qui est mis à jour par attachLocalListener
            const sessionLogs = window.currentLogs && window.currentLogs[sessionId] ? window.currentLogs[sessionId].exercises : {};

            session.blocks.forEach((block, blockIndex) => {
                // Début du bloc (Super-Set/Circuit)
                html += `
                    <div class="bg-slate-700 p-4 rounded-xl shadow-lg border border-slate-600 transition duration-300 hover:shadow-cyan-500/30">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center border-b border-slate-600 pb-2 mb-3">
                            <h3 class="text-xl font-extrabold text-cyan-300">
                                Bloc ${blockIndex + 1}
                            </h3>
                            <p class="text-sm text-slate-400 font-semibold mt-1 sm:mt-0">
                                Séries: <span class="text-white">${block.sets}</span> | Repos (Bloc): <span class="text-white">${block.rest}</span>
                            </p>
                        </div>
                        
                        <div class="space-y-4">
                `;

                // Itération sur les sous-exercices dans le bloc
                block.subExercises.forEach((subExo, subExoIndex) => {
                    // Logique de récupération: cherche le statut par nom du sous-exercice
                    const isDone = sessionLogs[subExo.name] ? !!sessionLogs[subExo.name].isDone : false;
                    
                    // Le handler utilise le nom du sous-exercice comme clé unique dans le log
                    const onChangeHandler = `window.debouncedToggleDone('${sessionId}', '${subExo.name}', this.checked)`;
                    const imageContainerId = `img-${sessionId}-${blockIndex}-${subExoIndex}`;
                    const placeholderId = `img-placeholder-${sessionId}-${blockIndex}-${subExoIndex}`;


                    html += `
                        <div class="pl-2 border-l-4 ${isDone ? 'border-green-500' : 'border-slate-500'} transition duration-300">
                            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center">
                                <h4 class="text-lg font-medium ${isDone ? 'text-green-300 line-through' : 'text-white'}">
                                    ${subExoIndex + 1}. ${subExo.name}
                                </h4>
                                
                                <div class="flex items-center space-x-3 mt-2 sm:mt-0">
                                    <!-- Répétitions/Durée spécifiques au sous-exercice -->
                                    <p class="text-sm text-slate-400 font-medium">
                                        Rép: <span class="font-semibold text-white">${subExo.reps}</span>
                                    </p>

                                    <!-- Contrôle Fait/Non Fait -->
                                    <div class="flex items-center">
                                        <label for="done-${sessionId}-${subExo.name.replace(/\s/g, '-')}" class="text-sm font-medium mr-2 cursor-pointer 
                                            ${isDone ? 'text-green-400' : 'text-slate-400'}">
                                            ${isDone ? 'FAIT' : 'À FAIRE'}
                                        </label>
                                        <input type="checkbox" 
                                            id="done-${sessionId}-${subExo.name.replace(/\s/g, '-')}" 
                                            class="cursor-pointer"
                                            ${isDone ? 'checked' : ''}
                                            onclick="${onChangeHandler}"
                                            onchange="
                                                const parentDiv = this.closest('.pl-2');
                                                parentDiv.classList.toggle('border-green-500', this.checked);
                                                parentDiv.classList.toggle('border-slate-500', !this.checked);

                                                const h4 = parentDiv.querySelector('h4');
                                                h4.classList.toggle('line-through', this.checked);
                                                h4.classList.toggle('text-green-300', this.checked);
                                                h4.classList.toggle('text-white', !this.checked);
                                                
                                                const label = parentDiv.querySelector('label');
                                                label.textContent = this.checked ? 'FAIT' : 'À FAIRE'; 
                                                label.classList.toggle('text-green-400', this.checked);
                                            "
                                        />
                                    </div>

                                    <!-- Bouton d'image, envoi de l'URL et du prompt -->
                                    <button onclick="window.toggleImage('${imageContainerId}', '${subExo.prompt.replace(/'/g, "\\'")}', '${subExo.imgUrl || ''}')"
                                        class="text-xs px-3 py-1 bg-cyan-600 text-white font-medium rounded-full hover:bg-cyan-500 transition duration-150 shadow-md flex-shrink-0">
                                        Voir
                                    </button>
                                </div>
                            </div>

                            <!-- Conteneur d'image pour le sous-exercice -->
                            <div id="${imageContainerId}" class="mt-3 hidden">
                                <div class="flex justify-center items-center h-48 bg-slate-600 rounded-lg" id="${placeholderId}">
                                    <p class="text-slate-400">Cliquez sur 'Voir' pour générer l'image.</p>
                                </div>
                            </div>
                        </div>
                    `;
                }); // Fin de la boucle subExercises

                html += `
                        </div>
                    </div>
                `;
            }); // Fin de la boucle blocks
            return html;
        }


        function renderCalendarView() {
            const today = new Date();
            const days = [];
            // Jours de la semaine en français (Dimanche=0, Lundi=1...)
            const dayNames = ['Dim', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam'];

            // Calculer les 90 jours
            for (let i = 0; i < 90; i++) {
                const date = new Date(today);
                date.setDate(today.getDate() + i);
                
                // VÉRIFICATION CRITIQUE: Le jour de la semaine (0 à 6) de la date calculée
                const dayOfWeek = date.getDay(); 
                const sessionName = window.program.weeklySchedule[dayOfWeek];

                days.push({
                    date: date,
                    dayName: dayNames[dayOfWeek],
                    session: sessionName,
                    isToday: i === 0
                });
            }

            let htmlContent = `
                <div class="bg-slate-800 p-6 rounded-2xl shadow-2xl border border-slate-700">
                    <h2 class="text-2xl font-bold text-cyan-400 mb-4">Planning Jours + 90</h2>
                    <div class="grid grid-cols-7 gap-1 text-center font-bold text-sm bg-slate-700 p-2 rounded-t-lg sticky top-0 z-10">
                        ${dayNames.map(d => `<div class="text-slate-300">${d}</div>`).join('')}
                    </div>
                    <div class="grid grid-cols-7 gap-1 text-xs pt-1">
                        ${days.map(day => `
                            <div class="p-1 rounded-lg border 
                                ${day.isToday ? 'bg-cyan-600 text-white shadow-lg font-extrabold border-cyan-400' : 'bg-slate-700 border-slate-600'} 
                                ${day.session === 'Repos' && !day.isToday ? 'bg-red-900/40 text-red-300' : (day.session !== 'Repos' && !day.isToday ? 'bg-green-900/40 text-green-300' : '')}
                                ">
                                <div class="font-bold">${day.date.getDate()}/${day.date.getMonth() + 1}</div>
                                <div class="text-[10px] ${day.isToday ? 'text-white' : 'text-slate-400 font-medium'} leading-tight mt-0.5">${day.session}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            document.getElementById('content-calendar').innerHTML = htmlContent;
        }


        // --- Logique d'image Gemini API ---

        // Masquer/Afficher l'image. Si masquée, elle est effacée. Gère maintenant les URLs d'images.
        window.toggleImage = function(containerId, prompt, imgUrl = '') {
            const container = document.getElementById(containerId);
            // Le placeholder est le premier enfant div du container
            const placeholder = container.querySelector('div[id^="img-placeholder"]');

            if (container.classList.contains('hidden')) {
                container.classList.remove('hidden');

                if (imgUrl) {
                    // 1. URL fournie: Afficher l'image directement
                    placeholder.innerHTML = `<img src="${imgUrl}" class="w-full h-auto object-contain max-h-48 rounded-lg" onerror="this.onerror=null; this.src='https://placehold.co/600x400/94a3b8/0f172a?text=Image+non+disponible'; this.closest('div').classList.add('bg-slate-600'); this.closest('div').style.height='12rem';" alt="Illustration de l'exercice par URL">`;
                    placeholder.classList.remove('bg-slate-600'); 
                    placeholder.style.height = 'auto'; // Ajuste la hauteur si l'image est chargée
                } else {
                    // 2. Pas d'URL: Générer l'image via l'API
                    placeholder.innerHTML = `<div class="flex flex-col items-center justify-center h-full"><span class="loading-ring"></span><p class="mt-3 text-slate-400">Génération de l'image...</p></div>`;
                    placeholder.style.height = '12rem'; // Hauteur par défaut pour le chargement
                    placeholder.classList.add('bg-slate-600');
                    window.generateImage(prompt, placeholder);
                }

            } else {
                container.classList.add('hidden');
                placeholder.innerHTML = `<p class="text-slate-400">Cliquez sur 'Voir' pour générer l'image.</p>`;
                placeholder.classList.add('bg-slate-600');
                placeholder.style.height = '12rem'; // Reset height
            }
        };


        let isImageGenerating = false;
        const IMAGE_MODEL_URL = 'https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=';
        const apiKey = ""; // La clé sera fournie par l'environnement Canvas

        window.generateImage = async function(userPrompt, placeholderElement) {
            if (isImageGenerating) {
                placeholderElement.innerHTML = `<p class="text-yellow-400">Veuillez attendre que l'image précédente soit générée.</p>`;
                return;
            }

            // Prompt de base pour un style d'entraînement réaliste
            const fullPrompt = `Une photo haute définition d'un athlète exécutant parfaitement l'exercice: ${userPrompt}. Style de photographie de guide de fitness, clair et sans distorsion, éclairage dramatique de salle de sport.`;

            placeholderElement.innerHTML = `<div class="flex flex-col items-center justify-center h-full"><span class="loading-ring"></span><p class="mt-3 text-slate-400">Génération de l'image...</p></div>`;
            isImageGenerating = true;

            const payload = {
                instances: [{ prompt: fullPrompt }],
                parameters: { "sampleCount": 1 }
            };

            const maxRetries = 5;
            let attempt = 0;

            while (attempt < maxRetries) {
                try {
                    const response = await fetch(IMAGE_MODEL_URL + apiKey, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    
                    const result = await response.json();

                    if (result.predictions && result.predictions.length > 0 && result.predictions[0].bytesBase64Encoded) {
                        const base64Data = result.predictions[0].bytesBase64Encoded;
                        const imageUrl = `data:image/png;base64,${base64Data}`;
                        // Remplacer le placeholder par l'image
                        placeholderElement.innerHTML = `<img src="${imageUrl}" class="w-full h-full object-contain rounded-lg" alt="Illustration de l'exercice">`;
                        // Ajuster le fond du conteneur parent pour qu'il soit transparent et laisser l'image s'afficher
                        placeholderElement.classList.remove('bg-slate-600'); 
                        placeholderElement.style.height = 'auto'; // Ajuste la hauteur
                        return; // Succès
                    } else {
                        throw new Error('Aucune donnée d\'image valide reçue.');
                    }
                } catch (error) {
                    console.error(`Erreur d'API (Tentative ${attempt + 1}):`, error);
                    attempt++;
                    if (attempt < maxRetries) {
                        const delay = Math.pow(2, attempt) * 1000; // Backoff exponentiel
                        placeholderElement.innerHTML = `<div class="flex flex-col items-center justify-center h-full"><span class="loading-ring"></span><p class="mt-3 text-red-400">Erreur, nouvelle tentative dans ${delay / 1000}s...</p></div>`;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    } else {
                        placeholderElement.innerHTML = `<p class="text-red-400">Erreur de génération d'image après plusieurs tentatives. Veuillez réessayer plus tard.</p>`;
                        return; // Échec
                    }
                } finally {
                    if (attempt >= maxRetries || (result && result.predictions && result.predictions.length > 0)) {
                        isImageGenerating = false;
                    }
                }
            }
        }


        // Démarrage de l'application
        window.onload = initializeApp;

    </script>
</head>
<body>
    <div id="app" class="container-app">
        <!-- Contenu de chargement initial -->
        <div class="flex justify-center items-center h-screen">
            <div class="loading-ring"></div>
            <p class="ml-3 text-gray-400">Chargement...</p>
        </div>
    </div>
</body>
</html>
